<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Data collection</title>

  <!-- Bootstrap core CSS -->
  <link href="css/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!-- Custom styles for this template -->
  <link href="heroic-features.css" rel="stylesheet" type="text/css">

</head>

<body>


  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">TOM</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
         
          <li class="nav-item">
            <a class="nav-link" href="#">Admin</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="alert alert-success" role="alert" id="dataQty">
    This is a success alertâ€”check it out!
  </div>
  <br>

  <!-- Page Content -->
  <div class="container">

    <!-- Jumbotron Header -->
    <header class="jumbotron my-4">
      <h5 class="display-5">Quick search</h5> 
      <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="search products" id="sKeyword" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" onclick="searchKeyowrd()" type="button">Search</button>
        </div>
      </div>
    </header>
    <br>
    <br>

    <!-- Page Features -->
    <div class="row text-center" id="dataPrint">


     
     


    </div>
    <!-- /.row -->
    <!-- <div class="row text-center">
   
    </div> -->
           <!-- paging  -->
    
	<nav aria-label="Page navigation example" class="col-xs-1" align="center"> 

  	<ul class="pagination" id="paging">
   
  	</ul>
	</nav>
	
  </div>
  <!-- /.container -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit Product</h5>
          <button type="button" class="close" data-dismiss="modal" id="hideModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h5>Title</h5>
          <input type="text" class="form-control" placeholder="input product name" id="title-product"  aria-describedby="basic-addon2">
          <br>
          <h5>Img url</h5>
          <div class="input-group mb-3">
            <input type="url" class="form-control" placeholder="example.org/img.jpg" id="image-input" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" id="check" type="button">Check</button>
              <br>
             
            </div>
          </div>
          <div class="alert alert-danger" id="alertMsg" role="alert">
           
          </div>
          <img src="" id="image" alt="">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeModal" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="submitBtn" >Save changes</button>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Footer -->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Your Website 2019</p>
    </div>
    <!-- /.container -->
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="js/vendor/jquery/jquery.min.js"></script>
  <script src="js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>

<style>
 
</style>


<script>


$(document).ready(function(){
	console.log("ready");
  //	loadProducts();
  	
  	let url = decodeURIComponent(location.href);
  	 console.log(url)
  	 if(url.indexOf('#') == -1) {
  		 searchPage(1);
  	 }else {
  		 let initJsonStr = url.substring(url.indexOf('#')+1, url.length);
  		 let initJson = JSON.parse(initJsonStr);
  		 initUiPrint(initJson);
  	 }
});

var isPressedBackKey = false;
window.onpopstate = function(event) {
	isPressedBackKey = true;
	if(event.state != null) {
		initUiprint(event.state);
	}
};

function initUiprint(uiState) {
	let nowPage = uiState['nowPage'];
	/* let perpage = uiState['perPage']; */
	
	searchPage(nowPage);
	
}

function searchPage(nowPage) {
	console.log("searchPage["+nowPage+"]");
	
	let urlParam = 'paging.nowPage=' + nowPage +
	'&paging.perpage=16';
	
	let url = 'api/products?'+urlParam;
	console.log("url :: "+url);
	
	var pageState = {
			'nowPage' : nowPage,
			'perPage' : 16
	};
	
	 $.ajax({
		    url: url,
		    type: 'GET',
		    success: function(data) {
		      console.log(data)
		      printData(data);
		      
		    },
		    error:function(request, status, error) {

		    }
		  })
	
}
function loadProducts() {

  let url = "api/products"
  console.log("url [ "+url+" ]")

  $.ajax({
    url: url,
    type: 'GET',
    success: function(data) {
      console.log(data)
      printData(data);
      
      if(isPressedBackKey == false) {
    	  history.pushState(pageState, null, '#' + encodeURI(JSON.stringify(pageState)));
      }else {
    	  isPressedBackKey = false;
      }
      
    },
    error:function(request, status, error) {

    }
  })
}

function printData(prods) {
	/* $('html:not(:animated),body:not(:animated)').animate({
        scrollTop: 0
    }, 2000); */
	
  let paging = prods['sparam']['paging'];
  
  let pages = paging['pages'];
	$("#paging").empty();
	$("#dataPrint").empty();
	 
	if(paging['prev_page'] != null) {
		$("#paging").append("<li class='page-item'><a href='javascript:searchPage("+paging['prev_page']+")'>Prev</a></li> &nbsp;&nbsp;");	
	}
	for(let i=0; i<pages.length; i++) {
		let page = pages[i];
		if(pages[i] == paging['now_page']) {
			$("#paging").append("<b>" + pages[i] + " </b>");
		} else {
			$("#paging").append("<li class='page-item'><a href='javascript:searchPage("+pages[i]+")'>" + pages[i] + " </a></li>");	
		}
	}
	if(paging['next_page'] != null) {
		$("#paging").append("&nbsp;&nbsp;<a href='javascript:searchPage("+paging['next_page']+")'>Next</a>");	
	}
	
  let append= ""
  let counter =0;
  let data = prods['list']
  for(let i=0; i<data.length; i++) {
    counter++;
    append =append + '<div class="col-lg-3 col-md-6 mb-4" id="'+data[i].id+'">' +
    '             <div class="card h-100">'+
    '      <img class="card-img-top" src="'+data[i].img_url+'" alt="">' +
    '     <div class="card-body">'+
    '        <p class="card-text">'+data[i].title+'</p>'+
    '     </div>'+
    '     <div class="card-footer">'+
    '        <button type="button" onclick="edit(\''+data[i].id+'\')"  class="btn btn-primary">Edit</button>'+
    '       <button type="button" onclick="remove(\''+data[i].id+'\')" class="btn btn-danger" >Remove</button>'+
    '     </div>'+
    '   </div>'+
    '  </div>';
  }
   console.log(append)
  $("#dataQty").html("All products is "+ counter);
  $("#dataPrint").append(append);
} 


function edit(num) {
//  alert("you pressed it "+num);

  $("#exampleModal").modal("show");
  $("#alertMsg").hide()
  $("#submitBtn").attr('onclick', 'SaveData(\''+num+'\')');

}

function SaveData(dataId) {
  if($("#image-input").val() == "" && $("#title-product").val() == "") {
    return alert("you have to fill at least one input")
  }
  $("#exampleModal").modal("hide")
   let title;
   let img_url;
  if($("#image-input").val() == "") {
    console.log("image value does not changed img input value is "+$("#image-input").val())
     title = $("#title-product").val();
     img_url = $("#"+dataId+" img").attr("src");
    console.log("title: "+title+ "/"+img_url)
  }else if($("#title-product").val()== null || $("#title-product").val() == "") {
    console.log("title does not changed input title value is "+$("#title-product").val());
    title = $("#"+dataId+" .card-body p").text();
    img_url = $("#image-input").val();
  } else {
    console.log("both data is changed "+$("#title-input").val()+"/"+$("#image-input").val());
    title = $("#title-input").val();
    img_url = $("#image-input").val();
  }
  let reqData = {
       id : dataId,
       title : title,
       img_url : img_url
  };
  console.log("you want edit this "+JSON.stringify(reqData));
  let jsonData = JSON.stringify(reqData);

  $.ajax({
    url : "api/edit_product",
    dataType: "json",
    data: jsonData,
  	type: 'POST',
  	success: function(data) {
      console.log(data)
      if(data == 1) {
        $("#"+dataId+" img").attr("src", img_url);
        $("#"+dataId+" .card-body p").text(title);  
      }else {
        alert("occured error while changing product")
      }
      $("#image").attr("src", " ");
      $("#image-input").val(" ");
      $("#title-product").val(" ");
    },
    error: function(request, status, error) {

    }
  }) 
}
function remove(num) {
  
  if(confirm("Are you sure you want to delete this item?")== false) {
    return
  }
  let reqData = {
    id : num
  };
  let jsonData = JSON.stringify(reqData);
  $.ajax({
    url: "api/remove_product",
    dataType : "json",
    data: jsonData,
    type: 'POST',
    success: function(data) {
      console.log(data)
      if(data == 1) {
          $("#"+num).remove();
      }
    }
  })
  alert("you deleted this item")
  // ajax
  //pass parameter to java spring
}




document.getElementById("check").addEventListener("click", e=> {
  let imageInput = document.getElementById("image-input")
  let image = document.getElementById("image")

  if (imageInput.value)  {
    $("#alertMsg").hide()
    image.src = imageInput.value;
    $("#image").on("error", ()=> {
      $(this).hide()
      $("#alertMsg").text("wrong img url path").show(250)
    })
     
  } else {
    
    $("#alertMsg").text("img url not found").show(250)
  }

});

document.getElementById("closeModal").addEventListener("click", e=> {
  $("#image").attr("src", " ");
  $("#image-input").val(" ");
  $("#title-product").val(" ");

})

document.getElementById("hideModal").addEventListener("click", e=> {
  $("#image").attr("src", " ");
  $("#image-input").val(" ");
  $("#title-product").val(" ");
})



function searchKeyowrd() {
	let keyowrd = $("#sKeyword").val().trim();
	console.log("keyword input is "+keyowrd)
	let keywordArr = keyowrd.split(" ");
	let keywordUrl = "";
	for(var i=0; i<keywordArr.length; i++) {
		keywordUrl = keywordUrl + "&keyword=" + keywordArr[i];
	}
	let url = 'api/search_products?' + keywordUrl;
	
	
	let pageState = {
			'keyword' : keyowrd
	}
	
	
	$.ajax({
	    url: url,
	    type: 'GET',
	    success: function(data) {
	      console.log(data)
	      printData(data);
	      
	      /* if(isPressedBackKey == false) {
	    	  history.pushState(pageState, null, '#' + encodeURI(JSON.stringify(pageState)));
	      }else {
	    	  isPressedBackKey = false;
	      } */
	      
	    },
	    error:function(request, status, error) {

	    }
	  })
	
	
}


</script>

</html>
